{
	# Admin endpoint disabled for production
	admin off
	
	# Auto HTTPS with Let's Encrypt (disabled for local development)
	# Uncomment the following line for production:
	# email your-email@example.com
	
	# Global options
	{
		servers {
			listen :80
		}
		
		# Graceful shutdown
		grace_period 5s
		
		# Log format
		log {
			output file /var/log/caddy/access.log {
				roll_size 100mb
				roll_keep 5
				roll_keep_for 720h
			}
			format json
		}
	}
}

# Main site configuration
:80 {
	# Root directory for static files
	root * /srv/site
	
	# Enable file server
	file_server
	
	# Security headers
	header {
		# HSTS
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		
		# Content Security Policy
		Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https:;"
		
		# Other security headers
		X-Content-Type-Options nosniff
		X-Frame-Options DENY
		X-XSS-Protection "1; mode=block"
		Referrer-Policy "strict-origin-when-cross-origin"
		Permissions-Policy "camera=(), microphone=(), geolocation=()"
	}
	
	# Compression
	encode {
		zstd
		gzip
	}
	
	# Cache static assets
	@static {
		path *.css *.js *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2 *.ttf *.eot
	}
	
	header @static Cache-Control "public, max-age=31536000, immutable"
	
	# Cache HTML files with shorter duration
	@html {
		path *.html
	}
	
	header @html Cache-Control "public, max-age=3600, must-revalidate"
	
	# Handle SPA routing (fallback to index.html for non-existent paths)
	@not_static {
		not path *.css *.js *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2 *.ttf *.eot *.html *.xml *.txt *.json
	}
	
	rewrite @not_static /index.html
	
	# Health check endpoint
	/health {
		respond 200 "OK"
	}
	
	# Custom error pages
	handle_errors {
		@404 expression {http.error.status_code} == 404
		handle @404 {
			rewrite /404.html
			file_server
		}
		
		@5xx expression {http.error.status_code} >= 500
		handle @5xx {
			respond "Server Error" 500
		}
	}
}